<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Cost Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 80rem;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .header-icon {
            color: #4f46e5;
            font-size: 2rem;
        }
        
        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .subtitle {
            color: #4b5563;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: all 0.15s;
        }
        
        input:focus {
            outline: none;
            border-color: #4f46e5;
            ring: 2px;
            ring-color: rgba(79, 70, 229, 0.5);
        }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        
        .grid-parts {
            display: grid;
            grid-template-columns: 1fr 80px auto;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .grid-zip {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        button {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            width: 100%;
            background: #4f46e5;
            color: white;
            padding: 0.75rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
        }
        
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-reset {
            width: 100%;
            background: #6b7280;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        
        .btn-reset:hover {
            background: #4b5563;
        }
        
        .btn-add {
            color: #4f46e5;
            background: transparent;
            padding: 0;
            font-weight: 500;
        }
        
        .btn-add:hover {
            color: #4338ca;
        }
        
        .btn-remove {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.5rem 0.75rem;
        }
        
        .btn-remove:hover {
            background: #fecaca;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
        }
        
        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
            accent-color: #4f46e5;
        }
        
        .error-message {
            padding: 0.75rem;
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .error-message p {
            color: #991b1b;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .hidden {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }
        
        .weight-breakdown {
            background: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #bfdbfe;
        }
        
        .weight-breakdown h3 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .weight-item {
            background: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            border: 1px solid #bfdbfe;
        }
        
        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.25rem;
        }
        
        .weight-part-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .weight-qty {
            color: #6b7280;
            margin-left: 0.5rem;
        }
        
        .weight-total {
            font-weight: 700;
            color: #4f46e5;
        }
        
        .weight-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .badge-db {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-mouser {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-digikey {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-ai {
            background: #e9d5ff;
            color: #6b21a8;
        }
        
        .weight-unit {
            color: #6b7280;
        }
        
        .weight-description {
            font-size: 0.75rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 0.25rem;
        }
        
        .weight-total-section {
            border-top: 2px solid #bfdbfe;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .weight-row {
            display: flex;
            justify-content: space-between;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .weight-final {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            color: #1f2937;
            font-size: 1rem;
            background: #eef2ff;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        
        .weight-final-value {
            color: #4f46e5;
        }
        
        .banner-success {
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .banner-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .banner-title {
            font-weight: 700;
            color: #065f46;
        }
        
        .banner-subtitle {
            font-size: 0.875rem;
            color: #047857;
        }
        
        .rate-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            background: #f9fafb;
            margin-bottom: 0.75rem;
        }
        
        .rate-card-recommended {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .rate-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rate-title {
            font-weight: 600;
            color: #1f2937;
        }
        
        .rate-subtitle {
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        .rate-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            text-align: right;
        }
        
        .rate-badge {
            font-size: 0.75rem;
            background: #4f46e5;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
            margin-top: 0.25rem;
        }
        
        .recommendation {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #fde047;
            background: #fef9c3;
        }
        
        .recommendation-success {
            border-color: #86efac;
            background: #d1fae5;
        }
        
        .recommendation-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .recommendation-text {
            color: #374151;
        }
        
        .savings {
            font-size: 0.875rem;
            color: #047857;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .footer {
            margin-top: 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        .footer p {
            margin-bottom: 0.5rem;
        }
        
        .footer p:last-child {
            margin-bottom: 0;
        }
        
        .text-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <div class="header">
                <span class="header-icon">üì¶</span>
                <h1>Shipping Cost Checker</h1>
            </div>
            <p class="subtitle">Auto-calculate weights and compare shipping rates to avoid overpaying</p>
        </div>

        <div class="grid">
            <!-- Input Section -->
            <div class="card">
                <h2>
                    <span>üßÆ</span>
                    Shipment Details
                </h2>

                <!-- Parts List -->
                <div class="mb-4">
                    <label>Parts List</label>
                    <div class="grid-parts">
                        <div class="text-label">Part Number</div>
                        <div class="text-label">Quantity</div>
                        <div></div>
                    </div>
                    <div id="parts-container">
                        <div class="grid-parts">
                            <input type="text" placeholder="Part Number" class="part-number">
                            <input type="number" placeholder="Qty" class="part-qty" value="1" min="1">
                            <div></div>
                        </div>
                    </div>
                    <button onclick="addPart()" class="btn-add mt-2">+ Add Part</button>
                </div>

                <!-- Origin & Destination -->
                <div class="grid-zip mb-4">
                    <div>
                        <label>Origin ZIP</label>
                        <input type="text" id="origin" placeholder="90210" maxlength="10">
                    </div>
                    <div>
                        <label>Destination ZIP</label>
                        <input type="text" id="destination" placeholder="10001" maxlength="10">
                    </div>
                </div>

                <!-- Residential -->
                <div class="mb-4">
                    <label class="checkbox-label">
                        <input type="checkbox" id="residential">
                        <span>Residential Delivery</span>
                    </label>
                </div>

                <!-- Vendor Quote -->
                <div class="mb-6">
                    <label>Vendor Shipping Quote (optional)</label>
                    <input type="number" id="vendor-quote" step="0.01" placeholder="$35.00">
                </div>

                <!-- Error Message -->
                <div id="error-message" class="error-message hidden">
                    <p></p>
                </div>

                <!-- Reset Button -->
                <button onclick="resetForm()" class="btn-reset">
                    <span>üîÑ</span>
                    <span>Reset Form</span>
                </button>

                <!-- Check Button -->
                <button onclick="checkShipping()" id="check-btn" class="btn-primary">
                    <span id="btn-icon">üöö</span>
                    <span id="btn-text">Check Shipping</span>
                </button>
            </div>

            <!-- Results Section -->
            <div class="card">
                <h2>
                    <span>üí∞</span>
                    Rate Comparison
                </h2>

                <div id="empty-state" class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <p>Enter shipment details and click "Check Shipping"</p>
                </div>

                <div id="results-container" class="hidden"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>Rules:</strong> Auto-approve if cheapest rate &lt; $20. Otherwise, recommend vendor if vendor ‚â§ our rate + $3, else recommend our account.</p>
            <p><strong>Weight Sources:</strong> Internal DB ‚Üí Mouser API ‚Üí Digikey API ‚Üí AI Estimate</p>
        </div>
    </div>

    <script>
        const PACKAGING_WEIGHT = 0.5;

        // Validate USA ZIP
        function isValidUSAZip(zip) {
            const zipRegex = /^\d{5}(-\d{4})?$/;
            return zipRegex.test(zip);
        }

        // Handle ZIP input
        function handleZipInput(input) {
            input.value = input.value.replace(/[^\d-]/g, '');
        }

        // Add ZIP validation to inputs
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('origin').addEventListener('input', function() {
                handleZipInput(this);
            });
            document.getElementById('destination').addEventListener('input', function() {
                handleZipInput(this);
            });
        });

        // Add part row
        function addPart() {
            const container = document.getElementById('parts-container');
            const div = document.createElement('div');
            div.className = 'grid-parts';
            div.innerHTML = `
                <input type="text" placeholder="Part Number" class="part-number">
                <input type="number" placeholder="Qty" class="part-qty" value="1" min="1">
                <button onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
            `;
            container.appendChild(div);
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.querySelector('p').textContent = '‚ùå ' + message;
            errorDiv.classList.remove('hidden');
        }

        // Hide error
        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        // Call Netlify function to get part weight
        async function fetchPartWeight(partNumber) {
            try {
                const response = await fetch('/.netlify/functions/get-part-weight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partNumber })
                });

                if (!response.ok) {
                    throw new Error('Failed to get part weight');
                }

                const data = await response.json();
                if (!data.weight || isNaN(data.weight)) {
                    throw new Error('Invalid weight from API');
                }

                return {
                    weight: Number(data.weight),
                    source: data.source || 'Unknown',
                    description: data.description || ''
                };
            } catch (error) {
                console.error('get-part-weight error for', partNumber, error);
                // Fallback: 0.01 lb with AI label
                return {
                    weight: 0.01,
                    source: 'AI Estimate',
                    description: 'Fallback estimated weight (API error)'
                };
            }
        }

        // Call Netlify function to get shipping rates
        async function fetchShippingRates(weight, originZip, destZip, residential) {
            try {
                const response = await fetch('/.netlify/functions/get-shipping-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        weight,
                        originZip,
                        destZip,
                        residential
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get shipping rates');
                }

                const data = await response.json();

                const upsRate = data?.ups?.ground ? parseFloat(data.ups.ground) : NaN;
                const fedexRate = data?.fedex?.ground ? parseFloat(data.fedex.ground) : NaN;

                if (isNaN(upsRate) || isNaN(fedexRate)) {
                    throw new Error('Invalid rate data from API');
                }

                return {
                    ups: { ground: upsRate, service: data.ups.service || 'UPS Ground' },
                    fedex: { ground: fedexRate, service: data.fedex.service || 'FedEx Ground' }
                };
            } catch (error) {
                console.error('get-shipping-rates error', error);
                // Fallback to simple formula similar to old behavior
                const baseRate = 15 + (weight * 2);
                const resFee = residential ? 4 : 0;
                const upsRate = baseRate + resFee + Math.random() * 3;
                const fedexRate = baseRate + resFee + Math.random() * 4 - 1;

                return {
                    ups: { ground: upsRate, service: 'UPS Ground (fallback)' },
                    fedex: { ground: fedexRate, service: 'FedEx Ground (fallback)' }
                };
            }
        }

        // Call Netlify function to log shipment
        async function logShipment(payload) {
            try {
                await fetch('/.netlify/functions/log-shipment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (error) {
                console.error('log-shipment error', error);
                // Don't block UI on logging failure
            }
        }

        // Reset form
        function resetForm() {
            // Clear all part inputs except first one
            const container = document.getElementById('parts-container');
            container.innerHTML = `
                <div class="grid-parts">
                    <input type="text" placeholder="Part Number" class="part-number">
                    <input type="number" placeholder="Qty" class="part-qty" value="1" min="1">
                    <div></div>
                </div>
            `;
            
            // Clear ZIP codes
            document.getElementById('origin').value = '';
            document.getElementById('destination').value = '';
            
            // Uncheck residential
            document.getElementById('residential').checked = false;
            
            // Clear vendor quote
            document.getElementById('vendor-quote').value = '';
            
            // Hide error
            hideError();
            
            // Clear results
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('results-container').innerHTML = '';
            
            // Reset button state
            const btn = document.getElementById('check-btn');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');
            btn.disabled = false;
            btnIcon.textContent = 'üöö';
            btnText.textContent = 'Check Shipping';
        }

        // Main function
        async function checkShipping() {
            hideError();
            
            const btn = document.getElementById('check-btn');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');
            const emptyState = document.getElementById('empty-state');
            const resultsContainer = document.getElementById('results-container');
            
            // Get inputs
            const partInputs = document.querySelectorAll('.part-number');
            const qtyInputs = document.querySelectorAll('.part-qty');
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const residential = document.getElementById('residential').checked;
            const vendorQuote = parseFloat(document.getElementById('vendor-quote').value) || 0;
            
            // Validation
            if (!origin || !destination || !partInputs[0].value.trim()) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (!isValidUSAZip(origin)) {
                showError('Wrong ZIP Code Entered - Origin ZIP code is invalid. Please enter a valid 5-digit USA ZIP code.');
                return;
            }
            
            if (!isValidUSAZip(destination)) {
                showError('Wrong ZIP Code Entered - Destination ZIP code is invalid. Please enter a valid 5-digit USA ZIP code.');
                return;
            }
            
            // Disable button
            btn.disabled = true;
            btnIcon.innerHTML = '<div class="spinner"></div>';
            btnText.textContent = 'Calculating...';

            try {
                // Collect weights
                let totalPartsWeight = 0;
                let weightItems = [];

                for (let i = 0; i < partInputs.length; i++) {
                    const partNumber = partInputs[i].value.trim();
                    const qty = parseInt(qtyInputs[i].value) || 1;
                    
                    if (!partNumber) continue;

                    // Call backend for each part weight
                    const weightInfo = await fetchPartWeight(partNumber);
                    const lineWeight = weightInfo.weight * qty;
                    totalPartsWeight += lineWeight;

                    weightItems.push({
                        partNumber,
                        qty,
                        unitWeight: weightInfo.weight,
                        lineWeight,
                        source: weightInfo.source,
                        description: weightInfo.description
                    });
                }

                const totalWeight = totalPartsWeight + PACKAGING_WEIGHT;

                // Get shipping rates from backend
                const rates = await fetchShippingRates(totalWeight, origin, destination, residential);
                const upsRate = rates.ups.ground;
                const fedexRate = rates.fedex.ground;

                const cheapestRate = Math.min(upsRate, fedexRate);
                const cheapestCarrier = upsRate <= fedexRate ? 'UPS' : 'FedEx';
                
                // Apply rules
                let autoApproved = cheapestRate < 20;
                let recommendation = '';
                let savings = 0;
                
                if (autoApproved) {
                    recommendation = `AUTO-APPROVED: Use ${cheapestCarrier} ($${cheapestRate.toFixed(2)})`;
                    savings = vendorQuote > 0 ? (vendorQuote - cheapestRate) : 0;
                } else {
                    const threshold = cheapestRate + 3;
                    if (vendorQuote > 0 && vendorQuote <= threshold) {
                        recommendation = "Use vendor's account";
                        savings = 0;
                    } else {
                        recommendation = `Use our ${cheapestCarrier} account`;
                        savings = vendorQuote > 0 ? (vendorQuote - cheapestRate) : 0;
                    }
                }

                // Display results
                emptyState.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                
                const getBadgeClass = (source) => {
                    if (source === 'Internal DB') return 'badge-db';
                    if (source === 'Mouser API') return 'badge-mouser';
                    if (source === 'Digikey API') return 'badge-digikey';
                    return 'badge-ai';
                };
                
                const getIcon = (source) => {
                    if (source === 'Internal DB') return 'üíæ';
                    if (source === 'Mouser API') return 'üåê';
                    if (source === 'Digikey API') return 'üî∑';
                    return 'ü§ñ';
                };
                
                let html = `
                    <!-- Weight Breakdown -->
                    <div class="weight-breakdown">
                        <h3>
                            <span>üßÆ</span>
                            Weight Calculation
                        </h3>
                        ${weightItems.map(item => `
                            <div class="weight-item">
                                <div class="weight-header">
                                    <div>
                                        <span class="weight-part-name">${item.partNumber}</span>
                                        <span class="weight-qty">√ó ${item.qty}</span>
                                    </div>
                                    <span class="weight-total">${item.lineWeight.toFixed(4)} lbs</span>
                                </div>
                                <div class="weight-details">
                                    <span class="badge ${getBadgeClass(item.source)}">
                                        ${getIcon(item.source)} ${item.source}
                                    </span>
                                    <span class="weight-unit">${item.unitWeight.toFixed(4)} lbs/unit</span>
                                </div>
                                ${item.description ? `<div class="weight-description">${item.description}</div>` : ''}
                            </div>
                        `).join('')}
                        <div class="weight-total-section">
                            <div class="weight-row">
                                <span>Parts Total:</span>
                                <span><strong>${totalPartsWeight.toFixed(4)} lbs</strong></span>
                            </div>
                            <div class="weight-row">
                                <span>Packaging Weight:</span>
                                <span><strong>${PACKAGING_WEIGHT.toFixed(3)} lbs</strong></span>
                            </div>
                            <div class="weight-final">
                                <span>Total Shipping Weight:</span>
                                <span class="weight-final-value">${totalWeight.toFixed(3)} lbs</span>
                            </div>
                        </div>
                    </div>
                    
                    ${autoApproved ? `
                        <div class="banner-success">
                            <span class="banner-icon">‚úÖ</span>
                            <div>
                                <div class="banner-title">AUTO-APPROVED</div>
                                <div class="banner-subtitle">Shipment under $20 threshold</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- UPS Rate -->
                    <div class="rate-card ${cheapestCarrier === 'UPS' && !autoApproved ? 'rate-card-recommended' : ''}">
                        <div class="rate-content">
                            <div>
                                <div class="rate-title">UPS Ground</div>
                                <div class="rate-subtitle">Our Account</div>
                            </div>
                            <div>
                                <div class="rate-price">$${upsRate.toFixed(2)}</div>
                                ${cheapestCarrier === 'UPS' && !autoApproved ? '<span class="rate-badge">Recommended</span>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- FedEx Rate -->
                    <div class="rate-card ${cheapestCarrier === 'FedEx' && !autoApproved ? 'rate-card-recommended' : ''}">
                        <div class="rate-content">
                            <div>
                                <div class="rate-title">FedEx Ground</div>
                                <div class="rate-subtitle">Our Account</div>
                            </div>
                            <div>
                                <div class="rate-price">$${fedexRate.toFixed(2)}</div>
                                ${cheapestCarrier === 'FedEx' && !autoApproved ? '<span class="rate-badge">Recommended</span>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${vendorQuote > 0 ? `
                        <div class="rate-card">
                            <div class="rate-content">
                                <div>
                                    <div class="rate-title">Vendor Quote</div>
                                    <div class="rate-subtitle">Vendor Account</div>
                                </div>
                                <div class="rate-price">$${vendorQuote.toFixed(2)}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Recommendation -->
                    <div class="recommendation ${autoApproved ? 'recommendation-success' : ''}">
                        <div class="recommendation-title">${autoApproved ? '‚úÖ' : 'üí°'} Recommendation</div>
                        <div class="recommendation-text">${recommendation}</div>
                        ${savings > 0 ? `<div class="savings">Potential Savings: $${savings.toFixed(2)}</div>` : ''}
                    </div>
                `;
                
                resultsContainer.innerHTML = html;

                // Log shipment (non-blocking)
                logShipment({
                    origin,
                    destination,
                    residential,
                    vendorQuote,
                    weights: {
                        items: weightItems,
                        partsWeight: totalPartsWeight,
                        packagingWeight: PACKAGING_WEIGHT,
                        totalWeight
                    },
                    rates: {
                        ups: upsRate,
                        fedex: fedexRate,
                        vendor: vendorQuote
                    },
                    recommendation,
                    autoApproved,
                    savings
                });
            } catch (err) {
                console.error('checkShipping error', err);
                showError('Something went wrong while calculating shipping. Please try again.');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btnIcon.textContent = 'üöö';
                btnText.textContent = 'Check Shipping';
            }
        }
    </script>
</body>
</html>
